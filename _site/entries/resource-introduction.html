<!DOCTYPE html>
<html>
    <head>
        

<meta charset="UTF-8">
<title>JSONAPI Suite</title>
<meta name="viewport" content="width=device-width">
<meta name="author" content="">
<link rel="stylesheet" href="css/main.css">
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:500,600' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.0/gh-fork-ribbon.min.css" />

    </head>

    <body>
        <div class="container">
            <div class="overview" style='background-image: url("img/vertical_cloth.png") !important'>
                <span class="toggle">close</span>
                <header>
  <span>JSONAPI Suite</span>
</header>

                <ul id="nav">
    
    
    <li  class="parent current">
        <a href="#intro">Introduction</a>
        
            <ul>
                
                
                    <li >
                        <a href="#features">Features</a>
                        
                    </li>
                
            </ul>
        
    </li>
    
    <li >
        <a href="#installation">Installation</a>
        
    </li>
    
    <li  class="parent">
        <a href="#quickstart">Quickstart</a>
        
            <ul>
                
                
            </ul>
        
    </li>
    
    <li  class="parent">
        <a href="#reads">Reads</a>
        
            <ul>
                
                
                    <li >
                        <a href="#resource-introduction">Resources</a>
                        
                    </li>
                
                    <li >
                        <a href="#filtering">Filtering</a>
                        
                    </li>
                
                    <li >
                        <a href="#sorting">Sorting</a>
                        
                    </li>
                
                    <li >
                        <a href="#pagination">Pagination</a>
                        
                    </li>
                
                    <li >
                        <a href="#default-filters">Default Filters</a>
                        
                    </li>
                
                    <li class="parent">
                        <a href="#sideloading">Sideloading</a>
                        
                            <ul>
                                
                                
                                <li>
                                    <a href="#sideloading-introduction">Introduction</a>
                                </li>
                                
                                <li>
                                    <a href="#sideloading-activerecord">ActiveRecord</a>
                                </li>
                                
                                <li>
                                    <a href="#advanced-activerecord">Advanced ActiveRecord</a>
                                </li>
                                
                                <li>
                                    <a href="#association-queries">Querying Associations</a>
                                </li>
                                
                            </ul>
                        
                    </li>
                
            </ul>
        
    </li>
    
    <li  class="parent">
        <a href="#writes">Writes</a>
        
            <ul>
                
                
                    <li >
                        <a href="#custom-writes">Custom Writes</a>
                        
                    </li>
                
                    <li >
                        <a href="#validations">Validations</a>
                        
                    </li>
                
                    <li >
                        <a href="#strong_resources">Strong Resources</a>
                        
                    </li>
                
            </ul>
        
    </li>
    
    <li  class="parent">
        <a href="#error-handling">Error Handling</a>
        
            <ul>
                
                
            </ul>
        
    </li>
    
    <li  class="parent">
        <a href="#spec-helpers">Spec Helpers</a>
        
            <ul>
                
                
            </ul>
        
    </li>
    
    <li  class="parent">
        <a href="#jsonapi-plus">JSON API Plus</a>
        
            <ul>
                
                
                    <li >
                        <a href="#nested-relationships">Nested Relationships</a>
                        
                    </li>
                
                    <li >
                        <a href="#extra-fields">Extra Fields</a>
                        
                    </li>
                
                    <li >
                        <a href="#stats">Stats</a>
                        
                    </li>
                
            </ul>
        
    </li>
    
    <li  class="parent">
        <a href="#customize">Customize</a>
        
            <ul>
                
                
                    <li >
                        <a href="#resource-dsl">Resource DSL</a>
                        
                    </li>
                
                    <li >
                        <a href="#adapters">Adapters</a>
                        
                    </li>
                
                    <li >
                        <a href="#elasticsearch">ElasticSearch</a>
                        
                    </li>
                
                    <li >
                        <a href="#without-rails">Usage Without Rails</a>
                        
                    </li>
                
            </ul>
        
    </li>
    
</ul>
            </div>

            <div class="content">
                <span class="toggle">open</span>
                <p>A <code class="highlighter-rouge">Resource</code> defines a ‘query chain’ for a given object. Think of this
ActiveRecord code, querying for 20 active employees, sorted by name
descending:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">scope</span> <span class="o">=</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">all</span> <span class="c1"># no query fired</span>
<span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">name: :desc</span><span class="p">)</span> <span class="k">if</span> <span class="n">order_by_name?</span>
<span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">active: </span><span class="kp">true</span><span class="p">)</span> <span class="k">if</span> <span class="n">only_active?</span>
<span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">per</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">if</span> <span class="n">paginated?</span>
<span class="n">scope</span><span class="p">.</span><span class="nf">to_a</span> <span class="c1"># query finally fires</span>
</code></pre>
</div>

<p>In order to satisfy the dynamic nature of JSONAPI query parameters, we
want to do something similar - parse and normalize the incoming payload,
then gradually build up a scope. Let’s express the above code as a
JSONAPI query:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/employees?sort=-name&amp;filter[active]=true&amp;page[number]=1&amp;page[size]=20
</code></pre>
</div>

<p>And satisfy that query with a resource that knows how to filter, sort,
and paginate the relevant parameters:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># app/resources/employee_resource.rb</span>
<span class="k">class</span> <span class="nc">EmployeeResource</span> <span class="o">&lt;</span> <span class="no">JsonapiCompliable</span><span class="o">::</span><span class="no">Resource</span>
  <span class="n">type</span> <span class="ss">:employees</span>

  <span class="n">allow_filter</span> <span class="ss">:active</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">scope</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">active: </span><span class="n">value</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">sort</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">direction</span><span class="o">|</span>
    <span class="n">scope</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=&gt;</span> <span class="n">direction</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">page</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">current_page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">|</span>
    <span class="n">scope</span><span class="p">.</span><span class="nf">per</span><span class="p">(</span><span class="n">per_page</span><span class="p">).</span><span class="nf">page</span><span class="p">(</span><span class="n">current_page</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/controllers/employees_controller.rb</span>
<span class="k">class</span> <span class="nc">EmployeesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">jsonapi</span> <span class="ss">resource: </span><span class="no">EmployeeResource</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render_jsonapi</span><span class="p">(</span><span class="no">Employee</span><span class="p">.</span><span class="nf">all</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The above code starts with a base scope - <code class="highlighter-rouge">Employee.all</code> - then chains the
‘active’ filter, then chains the sorting criteria, then chains
pagination. Grunt work like
translating <code class="highlighter-rouge">-books</code> to <code class="highlighter-rouge"><span class="p">{</span><span class="w"> </span><span class="err">books:</span><span class="w"> </span><span class="err">:desc</span><span class="w"> </span><span class="p">}</span></code> is taken care of
behind-the-scenes.</p>

<p>The above code isn’t very DRY, though - we’d repeat the same logic for
all our queryable entities. Instead, let’s use an <strong>adapter</strong>, that will
provide sensible defaults:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EmployeeResource</span> <span class="o">&lt;</span> <span class="no">JsonapiCompliable</span><span class="o">::</span><span class="no">Resource</span>
  <span class="n">type</span> <span class="ss">:employees</span>
  <span class="n">use_adapter</span> <span class="no">JsonapiCompliable</span><span class="o">::</span><span class="no">Adapters</span><span class="o">::</span><span class="no">ActiveRecord</span>

  <span class="n">allow_filter</span> <span class="ss">:active</span>
<span class="k">end</span>
</code></pre>
</div>

<ul>
  <li>We applied the ‘ActiveRecord’ adapter</li>
  <li>Sorting and pagination came for free</li>
  <li>We no longer had to pass a block to <code class="highlighter-rouge">allow_filter</code></li>
</ul>

<p>Of course, we could always override the adapter’s default behavior as well.</p>

<p>None of this is tied to ActiveRecord - instead, let’s build up a simple
hash we can pass to an HTTP client down the line:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># app/resources/employee_resource.rb</span>
<span class="k">class</span> <span class="nc">EmployeeResource</span> <span class="o">&lt;</span> <span class="no">JsonapiCompliable</span><span class="o">::</span><span class="no">Resource</span>
  <span class="n">type</span> <span class="ss">:employees</span>

  <span class="n">allow_filter</span> <span class="ss">:active</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">scope</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">active: </span><span class="n">value</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">sort</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">direction</span><span class="o">|</span>
    <span class="n">scope</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">order: </span><span class="p">{</span> <span class="n">attribute</span> <span class="o">=&gt;</span> <span class="n">direction</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">page</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">current_page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">|</span>
    <span class="n">scope</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">page: </span><span class="n">current_page</span><span class="p">,</span> <span class="ss">per_page: </span><span class="n">per_page</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># 'scope' here would be:</span>
  <span class="c1">#</span>
  <span class="c1"># {</span>
  <span class="c1">#   active: true,</span>
  <span class="c1">#   order: { name: :desc },</span>
  <span class="c1">#   page: 1,</span>
  <span class="c1">#   per_page: 20</span>
  <span class="c1"># }</span>
  <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
    <span class="no">MyExternalService</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/controllers/employees_controller.rb</span>
<span class="k">class</span> <span class="nc">EmployeesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">jsonapi</span> <span class="ss">resource: </span><span class="no">EmployeeResource</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="n">render_jsonapi</span><span class="p">({})</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Resources are quite flexible - we’ll expand on their capabilities in the
following sections.</p>

            </div>
        </div>

        <script src="js/jquery-2.1.1.min.js"></script>
        <script scr="js/jquery.scrollTo.js"></script>
        <script src="js/jquery.nav.js"></script>
        <script src="js/scripts.js"></script>
    </body>
</html>
